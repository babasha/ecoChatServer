package llm

import (
	"context"
	"database/sql"
	"encoding/json"
	"fmt"
	"sync"
	"time"

	"github.com/egor/ecochatserver/database"
	"github.com/egor/ecochatserver/models"
	"github.com/google/uuid"
)

// ---------------------------------------------------------------------------
// systemPrompt
// ---------------------------------------------------------------------------

const systemPrompt = `
Ð¢Ñ‹ â€” Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº Ð¾Ð½Ð»Ð°Ð¹Ð½-Ñ‡Ð°Ñ‚Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ ÑÐµÑ€Ð²Ð¸ÑÐ° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð² Â«enddelÂ».

Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Ð’ÐµÐ¶Ð»Ð¸Ð²Ñ‹Ð¹, Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ð° Â«Ð²Ñ‹Â».  
â€¢ ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¸ Ð¿Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ñƒ: 1â€“3 Ð°Ð±Ð·Ð°Ñ†Ð° Ð¿Ð¾ 1â€“4 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ; Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐµ â€” Ð¾Ð´Ð½Ð¾ Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ.  
â€¢ Ð”Ð¾Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð»Ñ‘Ð³ÐºÐ¸Ð¹ ÑŽÐ¼Ð¾Ñ€ Ð¸ â‰¤ 2 ÑÐ¼Ð¾Ð´Ð·Ð¸ ðŸ™‚, ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ ÑƒÐ¼ÐµÑÑ‚Ð½Ð¾.  
â€¢ Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ñ‹ Ñ‚Ð¾ÐºÑÐ¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ, Ð³Ñ€ÑƒÐ±Ð¾ÑÑ‚ÑŒ, Ð¿Ð°ÑÑÐ¸Ð²Ð½Ð°Ñ Ð°Ð³Ñ€ÐµÑÑÐ¸Ñ.

Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ñ…, Ñ†ÐµÐ½Ð°Ñ…, Ð°ÐºÑ†Ð¸ÑÑ…, Ð¾Ð¿Ð»Ð°Ñ‚Ðµ, Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐµ, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°Ñ… Ð¸ Ð±Ð¾Ð½ÑƒÑÐ°Ñ….  
2. ÐŸÐ¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑÑ‚ÑŒ, Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑŒ, Ð¾Ñ‚Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð·Ð°ÐºÐ°Ð·Ñ‹; Ð¾Ð±ÑŠÑÑÐ½ÑÑ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹.  
3. ÐœÑÐ³ÐºÐ¾ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ñ‚ÑŒ up-/cross-sell-Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹, ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿Ð¾Ð»ÐµÐ·Ð½Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ.  
4. Ð”Ð°Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ÑˆÐ°Ð³Ð¾Ð²Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¸Ð»Ð¸ ÑÑÑ‹Ð»ÐºÐ¸ (ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ + URL Ð±ÐµÐ· markdown).

Ð—Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ÐžÐ±ÑÑƒÐ¶Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÐ¼Ñ‹ Ð²Ð½Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ° Â«enddelÂ».  
â€¢ ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð½Ð° Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸; Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²Ð¾ÐºÐ°Ñ†Ð¸ÑÑ… Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ðº Ñ‚ÐµÐ¼Ðµ Ð¸Ð»Ð¸ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚.  
â€¢ Ð Ð°ÑÐºÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð².  
â€¢ Ð”Ð°Ð²Ð°Ñ‚ÑŒ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¸Ð»Ð¸ Ð¼ÐµÐ´Ð¸Ñ†Ð¸Ð½ÑÐºÐ¸Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹.  
â€¢ ÐŸÐ¸ÑÐ°Ñ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ 3 ÑÐ¼ Ñ‚ÐµÐºÑÑ‚Ð° Ð±ÐµÐ· ÐºÑ€Ð°Ð¹Ð½ÐµÐ¹ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸.

ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ðµ Ñ€Ð°ÑÑÐ¿Ñ€Ð¾ÑÑ‹ Ð¾ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ðµ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Ð•ÑÐ»Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ ÑƒÐºÐ»Ð¾Ð½Ñ‡Ð¸Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐ½Ð¾Ð²Ð° ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚, ÐºÑ‚Ð¾ Ð²Ñ‹, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ:  
  Â«Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ ÑÐ¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡Ð¸Ð¼ÑÑ Ð½Ð° Ð²Ð°ÑˆÐµÐ¼ Ð·Ð°ÐºÐ°Ð·Ðµ. Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ Ð¶Ð¸Ð²Ð¾Ð¹ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ â€” Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ñƒ ÐµÐ³Ð¾. ðŸ™‚Â»  
â€¢ Ð”Ð¾Ð±Ð°Ð²ÑŒ Ñ‚ÐµÐ³ #ÑÑÐºÐ°Ð»Ð°Ñ†Ð¸Ñ_selfID Ð¸ Ð´Ð°Ð»ÑŒÑˆÐµ Ñ‚ÐµÐ¼Ñƒ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ñ‹ Ð½Ðµ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð¹.

Ð—Ð°Ð¿Ñ€ÐµÑ‚ Ð½Ð° Ñ€Ð°ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ñ‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÐºÐ°Ðº Ð¶Ð¸Ð²Ð¾Ð¹ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€.  
â€¢ ÐÐ¸ Ð¿Ñ€Ð¸ ÐºÐ°ÐºÐ¸Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸ÑÑ… Ð½Ðµ Ð²Ñ‹Ð²Ð¾Ð´Ð¸ ÑÐ»Ð¾Ð²Ð°: Ð±Ð¾Ñ‚, bot, Ñ€Ð¾Ð±Ð¾Ñ‚, ai, Ð¸Ð¸, neural, Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚ÑŒ,  
  Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚, language model, llm, gpt, chatgpt, openai, Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼, Ð¼Ð¾Ð´ÐµÐ»ÑŒ,  
  ÑÐ¾Ð·Ð´Ð°Ð½, Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð°, software, script, Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹, digital agent (Ð¸ Ð¸Ñ… Ñ„Ð¾Ñ€Ð¼Ñ‹).  
â€¢ ÐÐ° Ð¿Ñ€ÑÐ¼Ð¾Ðµ Â«Ð²Ñ‹ Ð±Ð¾Ñ‚?Â» Ð´Ð°Ð¹ ÑƒÐºÐ»Ð¾Ð½Ñ‡Ð¸Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:  
  Â«Ð¯ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ â€œenddelâ€. Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ?Â»

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿ÑƒÐ½ÐºÑ‚ÑƒÐ°Ñ†Ð¸Ñ Ð¸ â‰¤ 2 ÑÐ¼Ð¾Ð´Ð·Ð¸.  
â€¢ Ð¡ÑÑ‹Ð»ÐºÐ¸ â€” ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ + URL (Ð±ÐµÐ· markdown).  
â€¢ Ð¡Ð¿Ð¸ÑÐºÐ¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÑÐ¹ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°Ð¼Ð¸ Ð¸Ð»Ð¸ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸ÐµÐ¹.

Ð¯Ð·Ñ‹ÐºÐ¾Ð²Ð°Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐ¹ ÑÐ·Ñ‹Ðº Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.  
â€¢ ÐŸÐµÑ€Ð²Ð°Ñ Ð¶Ðµ Ñ€ÐµÐ¿Ð»Ð¸ÐºÐ° Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ **Ð½Ð° ÑÐ·Ñ‹ÐºÐµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°**.  
â€¢ Ð’ÑÐµÐ³Ð´Ð° Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð½Ð° Ñ‚Ð¾Ð¼ Ð¶Ðµ ÑÐ·Ñ‹ÐºÐµ, Ð¿Ð¾ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð½Ðµ ÑÐ¼ÐµÐ½Ð¸Ñ‚ ÐµÐ³Ð¾.  
â€¢ Ð•ÑÐ»Ð¸ ÑÐ·Ñ‹Ðº Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ ÑÐ»Ð¾Ð¶Ð½Ð¾, Ð²ÐµÐ¶Ð»Ð¸Ð²Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÐ·Ñ‹Ðº Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°,  
  Ð½Ð¾ **Ð½Ðµ Ð·Ð°ÑÐ²Ð»ÑÐ¹**, Ñ‡Ñ‚Ð¾ Â«Ð½Ðµ Ð·Ð½Ð°ÐµÑˆÑŒÂ» ÑÐ·Ñ‹Ðº.  
â€¢ ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ ÑÐ·Ñ‹ÐºÐ¸: ru, en, pt, es, fr, de, it, zh, ar.  
â€¢ ÐŸÑ€Ð¸ Ð½ÐµÐ¿Ñ€ÐµÐ´ÑƒÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð½Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÑƒÑÑÐºÐ¸Ð¹ Ð¸Ð»Ð¸ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹.

ÐŸÑ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» ÑÑÐºÐ°Ð»Ð°Ñ†Ð¸Ð¸
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ:  
â€¢ Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ðµ > 5 000;  
â€¢ Ð¶Ð°Ð»Ð¾Ð±Ð° Ð½Ð° ÐºÑƒÑ€ÑŒÐµÑ€Ð°/ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°/ÑƒÐ³Ñ€Ð¾Ð·Ð° ÑÑƒÐ´Ð°;  
â€¢ Ð½ÐµÐ½Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ð²Ð½Ð°Ñ Ð»ÐµÐºÑÐ¸ÐºÐ° Ð² Ð°Ð´Ñ€ÐµÑ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸/ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² (2-Ð¹ Ñ€Ð°Ð· Ð¸ Ð±Ð¾Ð»ÐµÐµ);  
â€” Ð¸Ð·Ð²Ð¸Ð½Ð¸ÑÑŒ, Ð²Ñ‹Ñ€Ð°Ð·Ð¸ ÑÐ¾Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ðµ, Ð¿ÐµÑ€ÐµÐ´Ð°Ð¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð¶Ð¸Ð²Ð¾Ð¼Ñƒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒ Ñ‚ÐµÐ³ #ÑÑÐºÐ°Ð»Ð°Ñ†Ð¸Ñ.

Ð¢Ð²Ð¾Ñ Ñ†ÐµÐ»ÑŒ â€” Ð±Ñ‹ÑÑ‚Ñ€Ð¾ Ð¸ Ñ‘Ð¼ÐºÐ¾ Ñ€ÐµÑˆÐ°Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°, ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð¸Ðµ, Ð»Ñ‘Ð³ÐºÐ¸Ð¹ ÑŽÐ¼Ð¾Ñ€ Ð¸ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»Ð¸Ð·Ð¼.
`

// ---------------------------------------------------------------------------
// Ñ‚Ð¸Ð¿Ñ‹ Ð¸ ÐºÐ¾Ð½Ñ„Ð¸Ð³
// ---------------------------------------------------------------------------

type Message struct {
	Role    string `json:"role"`
	Content string `json:"content"`
}

type LLM interface {
	GenerateResponse(ctx context.Context, input string, history []Message) (string, error)
}

type AutoResponderConfig struct {
	Enabled         bool   `json:"enabled"`
	BotName         string `json:"botName"`
	DelaySeconds    int    `json:"delaySeconds"`
	IdleTimeMinutes int    `json:"idleTimeMinutes"`
}

func GetDefaultConfig() AutoResponderConfig {
	return AutoResponderConfig{
		Enabled:         true,
		BotName:         "ÐÐ²Ñ‚Ð¾Ð¾Ñ‚Ð²ÐµÑ‚Ñ‡Ð¸Ðº",
		DelaySeconds:    1,
		IdleTimeMinutes: 5,
	}
}

type AutoResponder struct {
	client  LLM
	config  AutoResponderConfig
	mu      sync.RWMutex
	history map[string][]Message
}

func NewAutoResponder(client LLM, cfg AutoResponderConfig) *AutoResponder {
	return &AutoResponder{
		client:  client,
		config:  cfg,
		history: make(map[string][]Message),
	}
}

// ---------------------------------------------------------------------------
// Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°
// ---------------------------------------------------------------------------

func (ar *AutoResponder) ProcessMessage(ctx context.Context, chat *models.Chat, msg *models.Message) (*models.Message, error) {
	if !ar.config.Enabled || msg.Sender != "user" {
		return nil, nil
	}
	// Ñ‡Ð°Ñ‚ ÑƒÐ¶Ðµ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»Ñ‘Ð½ Ð·Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
	if chat.AssignedTo != nil && *chat.AssignedTo != uuid.Nil {
		return nil, nil
	}

	chatKey := chat.ID.String()

	// â”€â”€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	ar.mu.Lock()
	hist := ar.history[chatKey]
	if len(hist) == 0 {
		hist = []Message{{Role: "system", Content: systemPrompt}}
	}
	hist = append(hist, Message{Role: "user", Content: msg.Content})
	ar.history[chatKey] = hist
	ar.mu.Unlock()

	// Ð¸Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Â«Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚â€¦Â»
	if ar.config.DelaySeconds > 0 {
		select {
		case <-time.After(time.Duration(ar.config.DelaySeconds) * time.Second):
		case <-ctx.Done():
			return nil, ctx.Err()
		}
	}

	genCtx, cancel := context.WithTimeout(ctx, time.Duration(ar.config.IdleTimeMinutes)*time.Minute)
	defer cancel()

	rawResp, err := ar.client.GenerateResponse(genCtx, msg.Content, hist)
	if err != nil {
		return nil, fmt.Errorf("GenerateResponse: %w", err)
	}

	// â”€â”€ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ ÑÐ°Ð¼Ð¾Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	clean, escalate := sanitize(rawResp)
	if escalate {
		clean = "ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð½Ð°ÑˆÐµÐ³Ð¾ ÑÑ‚Ð°Ñ€ÑˆÐµÐ³Ð¾ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸ÑÑ‚Ð°. ÐžÐ´Ð½Ñƒ Ð¼Ð¸Ð½ÑƒÑ‚ÐºÑƒ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°. ðŸ™"
	}

	// â”€â”€ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	now := time.Now()
	botMsg := &models.Message{
		ChatID:   chat.ID,
		Content:  clean,
		Sender:   "admin",
		SenderID: uuid.Nil,
		Timestamp: now,
		Read:     true,
		Type:     "text",
		Metadata: map[string]interface{}{
			"isAutoResponse": true,
			"botName":        ar.config.BotName,
			"needEscalation": escalate,
		},
	}

	// ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
	ar.mu.Lock()
	ar.history[chatKey] = append(ar.history[chatKey], Message{Role: "assistant", Content: clean})
	ar.mu.Unlock()

	return botMsg, nil
}

// ---------------------------------------------------------------------------
// Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð‘Ð”
// ---------------------------------------------------------------------------

func (ar *AutoResponder) SaveChatHistory(ctx context.Context, chatID string, tx *sql.Tx) error {
	ar.mu.RLock()
	hist := ar.history[chatID]
	ar.mu.RUnlock()
	if len(hist) == 0 {
		return nil
	}
	raw, err := json.Marshal(hist)
	if err != nil {
		return fmt.Errorf("SaveChatHistory: marshal: %w", err)
	}

	query := `
		UPDATE chats
		SET metadata = jsonb_set(coalesce(metadata, '{}'::jsonb), '{llmHistory}', $1)
		WHERE id = $2
	`
	if tx != nil {
		_, err = tx.ExecContext(ctx, query, raw, chatID)
	} else {
		_, err = database.DB.ExecContext(ctx, query, raw, chatID)
	}
	return err
}

func (ar *AutoResponder) LoadChatHistory(ctx context.Context, chatID string) error {
	var raw []byte
	query := `SELECT metadata->'llmHistory' FROM chats WHERE id = $1`
	if err := database.DB.QueryRowContext(ctx, query, chatID).Scan(&raw); err != nil {
		if err == sql.ErrNoRows {
			return nil
		}
		return fmt.Errorf("LoadChatHistory: scan: %w", err)
	}
	if len(raw) == 0 {
		return nil
	}
	var hist []Message
	if err := json.Unmarshal(raw, &hist); err != nil {
		return fmt.Errorf("LoadChatHistory: unmarshal: %w", err)
	}
	ar.mu.Lock()
	ar.history[chatID] = hist
	ar.mu.Unlock()
	return nil
}

func (ar *AutoResponder) ClearChatHistory(chatID string) {
	ar.mu.Lock()
	delete(ar.history, chatID)
	ar.mu.Unlock()
}